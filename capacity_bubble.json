    {
    "$schema": "https://vega.github.io/schema/vega/v5.json",
    "description": "Packed bubble chart: total capacity by Parking Type (color) Ã— Access (bubble).",
    "width": 800,
    "height": 560,
    "autosize": "none",

    "data": [
        {
        "name": "raw",
        "url": "bike-data-original.csv",
        "format": { "type": "csv" },
        "transform": [
            { "type": "formula", "as": "cap_num", "expr": "toNumber(datum.capacity || datum.total_capacity || 0)" },

            { "type": "formula", "as": "type_lower", "expr": "lower(datum.bicycle_parking || '')" },
            {
            "type": "formula",
            "as": "ParkingType",
            "expr": "datum.type_lower==='stands' ? 'Stands' : datum.type_lower==='shed' ? 'Shed' : datum.type_lower==='building' ? 'Building' : 'Other'"
            },

            { "type": "formula", "as": "access_lower", "expr": "lower(datum.access || '')" },
            {
            "type": "formula",
            "as": "Access",
            "expr": "datum.access_lower==='nil' ? 'Open' : datum.access_lower==='permit' ? 'Permit' : datum.access_lower==='residents' ? 'Residents' : 'Other'"
            },

            { "type": "filter", "expr": "indexof(['Stands','Shed','Building'], datum.ParkingType) >= 0" },
            { "type": "filter", "expr": "indexof(['Open','Permit','Residents'], datum.Access) >= 0" },

            { "type": "aggregate", "groupby": ["ParkingType", "Access"], "ops": ["sum"], "fields": ["cap_num"], "as": ["cap_sum"] },

            { "type": "impute", "field": "cap_sum", "groupby": ["ParkingType"], "key": "Access", "method": "value", "value": 0 },
            { "type": "impute", "field": "cap_sum", "groupby": ["Access"], "key": "ParkingType", "method": "value", "value": 0 }
        ]
        },

        {
        "name": "tree",
        "source": "raw",
        "transform": [
            { "type": "nest", "keys": ["ParkingType", "Access"] },           

            { "type": "formula", "as": "value", "expr": "datum.cap_sum || 0" },

            {
            "type": "pack",
            "field": "value",
            "sort": { "field": "value", "order": "descending" },
            "size": [{ "signal": "width" }, { "signal": "height" }],
            "padding": 4
            }
        ]
        },

        { "name": "leaves", "source": "tree", "transform": [ { "type": "filter", "expr": "!datum.children" } ] }
    ],

    "scales": [
        {
        "name": "color",
        "type": "ordinal",
        "domain": ["Stands", "Shed", "Building"],
        "range": ["#3690c0", "#74a9cf", "#0570b0"]
        }
    ],

    "legends": [
        { "fill": "color", "title": "Parking Type" }
    ],

    "marks": [
        {
        "type": "symbol",
        "from": { "data": "leaves" },
        "encode": {
            "enter": {
            "stroke": { "value": "white" },
            "strokeWidth": { "value": 1 }
            },
            "update": {
            "x": { "field": "x" },
            "y": { "field": "y" },
            "size": { "signal": "PI * datum.r * datum.r" },
            "fill": { "scale": "color", "field": "ParkingType" },
            "tooltip": {
                "signal": "{'Parking Type': datum.ParkingType, 'Access': datum.Access, 'Total capacity': datum.value}"
            }
            }
        }
        },
        {
        "type": "text",
        "from": { "data": "leaves" },
        "encode": {
            "enter": {
            "align": { "value": "center" },
            "baseline": { "value": "middle" },
            "fill": { "value": "white" }
            },
            "update": {
            "x": { "field": "x" },
            "y": { "field": "y" },
            "fontSize": { "signal": "clamp(datum.r/3, 10, 18)" },
            "text": { "signal": "datum.Access + ' ' + format(datum.value, ',.0f')" }
            }
        }
        }
    ],

    "config": { "view": { "stroke": null } }
    }

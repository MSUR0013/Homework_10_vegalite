  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>Clayton Campus Bike Availability</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
          integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
          crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Vega -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <!-- d3 -->
    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>

    <style>
      body { padding: 1rem; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #fafafa; }
      h1 { text-align: center; font-size: 2rem; font-weight: 700; color: #034e7b; margin-bottom: 0.75rem; }
      .intro { margin: 0 auto 1.5rem auto; max-width: 960px; font-size: 1rem; line-height: 1.6; color: #333; text-align: center; }
      #map-internal { height: 480px; margin-bottom: 24px; background: #f8f9fb; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
      .charts { display: grid; grid-template-columns: 1fr; gap: 24px; }
      @media (min-width: 1100px) { .charts { grid-template-columns: 1fr 1fr; } }
      .chart { min-height: 360px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 8px; }
      #capacity-matrix, #parking-distribution, #capacity-bubble { grid-column: 1 / -1; }
    </style>
  </head>
  <body>
    <h1>Clayton Campus Bike Availability</h1>

    <div class="intro">
      Cycling is one of the most sustainable and efficient ways to move around urban areas.
      At Monash University’s Clayton campus, bike use helps reduce traffic congestion,
      lower carbon emissions, and promote healthier lifestyles among students and staff.
      The university supports this through well-distributed bike parking zones, lighting for safety at night,
      and access options suited to different users. The map below shows the spatial distribution of bike parking
      availability across the Clayton campus, helping cyclists find convenient and secure places to park their bikes.
    </div>

    <form id="filter" class="pure-form pure-form-stacked">
      <label for="filter-is-lit">Lit during night</label>
      <input id="filter-is-lit" type="checkbox">

      <label for="filter-parking-type">Parking type</label>
      <select id="filter-parking-type">
        <option value="all">All</option>
        <option value="stands">Bike Stands/Racks</option>
        <option value="shed">Bike Shed</option>
        <option value="building">Indoor Bike Stations</option>
      </select>

      <label for="filter-parking-access">Parking access</label>
      <select id="filter-parking-access">
        <option value="all">All</option>
        <option value="nil">Open</option>
        <option value="permit">Permit</option>
        <option value="residents">Residents</option>
      </select>
    </form>

    <div id="map-internal"></div>

    <div class="charts">
      <div id="lights-chart" class="chart"></div>
      <div id="access-donut" class="chart"></div>
      <div id="capacity-matrix" class="chart"></div>
      <div id="parking-distribution" class="chart"></div>
      <div id="capacity-bubble" class="chart"></div>
    </div>

    <script>
      /* ===== Map ===== */
      function getColorShade(s){ if(s>=.125)return"#034e7b"; if(s>=.1)return"#0570b0"; if(s>=.075)return"#3690c0"; if(s>=.05)return"#74a9cf"; if(s>=.025)return"#a6bddb"; if(s>0)return"#d0d1e6"; return"#f1eef6"; }

      function styleGroup(f,agg){
        const els=document.getElementById("filter").elements;
        const isLit=els.namedItem("filter-is-lit").checked;
        const pType=els.namedItem("filter-parking-type").value;
        const acc=els.namedItem("filter-parking-access").value;
        let grand=0, total=0;
        agg.forEach(r=>{
          if(isLit && r.lit!=="yes") return;
          if(pType!=="all" && r.bicycle_parking!==pType) return;
          if(acc!=="all" && r.access!==acc) return;
          grand+=Number(r.total_capacity);
          if(r.group!==f.properties.group) return;
          total+=Number(r.total_capacity);
        });
        return { fillColor:getColorShade(grand? total/grand:0), weight:2, opacity:1, fillOpacity:.7, color:"#034e7b", dashArray:"3" };
      }

      (async function(){
        try{
          const map=L.map("map-internal").setView([-37.909,145.136],15);
          L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(map);
          const [groups, agg]=await Promise.all([fetch("monash-clayton-groups.json").then(r=>r.json()), d3.csv("bike-data-per-group.csv")]);
          const layer=L.geoJson(groups,{
            onEachFeature:(f,l)=>{
              l.on("click", ()=>{
                const els=document.getElementById("filter").elements;
                const isLit=els.namedItem("filter-is-lit").checked;
                const pType=els.namedItem("filter-parking-type").value;
                const acc=els.namedItem("filter-parking-access").value;
                let totC=0, totL=0, gC=0, gL=0;
                agg.forEach(r=>{
                  if(isLit && r.lit!=="yes") return;
                  if(pType!=="all" && r.bicycle_parking!==pType) return;
                  if(acc!=="all" && r.access!==acc) return;
                  gC+=Number(r.total_capacity); gL+=Number(r.total_locations);
                  if(r.group!==f.properties.group) return;
                  totC+=Number(r.total_capacity); totL+=Number(r.total_locations);
                });
                l.bindPopup(`<h4>${f.properties.name}</h4><p>Total parking spots: ${totL} (out of ${gL})</p><p>Total capacity: ${totC} bikes (out of ${gC})</p>`).openPopup();
              });
            },
            style:(f)=>styleGroup(f,agg)
          }).addTo(map);
          document.getElementById("filter").addEventListener("change", ()=>layer.resetStyle());
        }catch(e){console.error("Map failed:",e);}
      })();

      /* ===== Inline Matrix Chart ===== */
      const matrixSpec = {
        "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
        "description":"3x3 matrix showing total capacity by parking type × access",
        "width":"container","height":420,
        "data":{"url":"bike-data-original.csv","format":{"type":"csv"}},
        "transform":[
          {"calculate":"lower(datum.bicycle_parking || '')","as":"type_lower"},
          {"calculate":"datum.type_lower==='stands' ? 'Stands' : datum.type_lower==='shed' ? 'Shed' : datum.type_lower==='building' ? 'Building' : 'Other'","as":"ParkingType"},
          {"calculate":"lower(datum.access || '')","as":"access_lower"},
          {"calculate":"datum.access_lower==='nil' ? 'Open' : datum.access_lower==='permit' ? 'Permit' : datum.access_lower==='residents' ? 'Residents' : 'Other'","as":"Access"},
          {"calculate":"toNumber(datum.capacity || datum.total_capacity || 0)","as":"cap_num"},
          {"aggregate":[{"op":"sum","field":"cap_num","as":"cap_sum"}],"groupby":["ParkingType","Access"]},
          {"impute":"cap_sum","key":"Access","groupby":["ParkingType"],"method":"value","value":0},
          {"impute":"cap_sum","key":"ParkingType","groupby":["Access"],"method":"value","value":0},
          {"filter":"indexof(['Stands','Shed','Building'], datum.ParkingType) >= 0"},
          {"filter":"indexof(['Open','Permit','Residents'], datum.Access) >= 0"}
        ],
        "layer":[
          {"mark":"rect","encoding":{
            "x":{"field":"Access","type":"nominal","title":"Access Type","sort":["Open","Permit","Residents"]},
            "y":{"field":"ParkingType","type":"nominal","title":"Parking Type","sort":["Stands","Shed","Building"]},
            "color":{"field":"cap_sum","type":"quantitative","title":"Total Capacity","scale":{"scheme":"blues"}},
            "tooltip":[{"field":"ParkingType"},{"field":"Access"},{"field":"cap_sum","type":"quantitative","title":"Total Capacity"}]
          }},
          {"mark":{"type":"text","baseline":"middle","align":"center"},
          "encoding":{
            "x":{"field":"Access","type":"nominal","sort":["Open","Permit","Residents"]},
            "y":{"field":"ParkingType","type":"nominal","sort":["Stands","Shed","Building"]},
            "text":{"field":"cap_sum","type":"quantitative","format":".0f"},
            "color":{"condition":{"test":"datum.cap_sum > 600","value":"white"},"value":"black"}
          }}
        ],
        "title":{"text":"Capacity Matrix (Parking Type × Access)","fontSize":16,"fontWeight":"bold","anchor":"middle"}
      };

      /* ===== Load External Charts + Matrix Inline ===== */
      (async function loadCharts(){
        try{ await vegaEmbed("#capacity-matrix", matrixSpec, { actions:false }); }catch(e){ console.error("Matrix failed:", e); }

        const charts = [
          ["#lights-chart", "bar_chart.json"],
          ["#access-donut", "access_donut.json"],
          ["#parking-distribution", "parking_distribution.json"],
          ["#capacity-bubble", "capacity_bubble.json"]
        ];
        for (const [sel, file] of charts){
          try{ await vegaEmbed(sel, file, { actions:false }); }
          catch(e){ console.error(`Failed to load ${file}:`, e); }
        }
      })();
    </script>
  </body>
  </html>

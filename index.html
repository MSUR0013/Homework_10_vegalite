
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Clayton Campus Bike Availability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <!-- Vega libraries to render the JSON bar chart -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <!-- d3 for CSV used by the map -->
  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>

  <style>
    #map-internal { min-height: 20rem; }
  </style>
</head>
<body class="p-4">
  <div class="row">
    <div class="col-12 my-3">
      <h1>Clayton Campus Bike Parking Availability</h1>
    </div>
    <div class="col-12 col-md-8 my-3">
      <div id="map-internal"></div>
    </div>
    <form id="filter" class="col-12 col-md-4 my-3">
      <div class="card">
        <div class="card-header"><h5 class="m-0">Filter</h5></div>
        <div class="card-body">
          <div class="mb-3 form-check form-switch">
            <label for="filter-is-lit" class="form-check-label">Lit during night</label>
            <input id="filter-is-lit" class="form-check-input" type="checkbox" role="switch" switch>
          </div>
          <div class="mb-3">
            <label for="filter-parking-type" class="form-label">Parking type</label>
            <select id="filter-parking-type" class="form-select">
              <option value="all">All</option>
              <option value="stands">Bike Stands/Racks</option>
              <option value="shed">Bike Shed</option>
              <option value="building">Indoor Bike Stations</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="filter-parking-access" class="form-label">Parking access</label>
            <select id="filter-parking-access" class="form-select">
              <option value="all">All</option>
              <option value="nil">Open</option>
              <option value="permit">By Permit</option>
              <option value="residents">Residents</option>
            </select>
          </div>
        </div>
      </div>
    </form>

    <!-- Bar chart container -->
    <div class="col-12 col-sm-6 col-md-4 my-3">
      <div id="lights-chart" class="ratio ratio-1x1"></div>
    </div>

    <!-- Other chart container (visualisation not ready) -->
    <div class="col-12 col-sm-6 col-md-4 my-3">
      <div class="ratio ratio-1x1 bg-primary-subtle">
        Chart 3
      </div>
    </div>

    <!-- Other chart container (visualisation not ready) -->
    <div class="col-12 col-sm-6 col-md-4 my-3">
      <div class="ratio ratio-1x1 bg-success-subtle">
        Chart 4
      </div>
    </div>
  </div>

  <script>
    // Map coloring helper
    function getColorShade(scale) {
      if (scale >= 0.125) return "#034e7b";
      else if (scale >= 0.100) return "#0570b0";
      else if (scale >= 0.075) return "#3690c0";
      else if (scale >= 0.050) return "#74a9cf";
      else if (scale >= 0.025) return "#a6bddb";
      else if (scale > 0) return "#d0d1e6";
      else return "#f1eef6";
    }

    function styleGroup(groupData, aggregateData) {
      const form = document.getElementById("filter").elements;
      const isLit = form.namedItem("filter-is-lit").checked;
      const parkingType = form.namedItem("filter-parking-type").value;
      const parkingAccess = form.namedItem("filter-parking-access").value;

      let grandTotalCapacity = 0;
      let totalCapacity = 0;

      aggregateData.forEach(function (row) {
        if (isLit && row.lit !== "yes") return;
        if (parkingType !== "all" && row.bicycle_parking !== parkingType) return;
        if (parkingAccess !== "all" && row.access !== parkingAccess) return;

        grandTotalCapacity += Number(row.total_capacity);
        if (row.group !== groupData.properties.group) return;
        totalCapacity += Number(row.total_capacity);
      });

      const shade = getColorShade(grandTotalCapacity ? totalCapacity / grandTotalCapacity : 0);
      return {
        fillColor: shade,
        weight: 2,
        opacity: 1,
        fillOpacity: 0.7,
        color: "#034e7b",
        dashArray: "3"
      };
    }

    // Initialize Leaflet map and groups
    (async function () {
      const groupData = await fetch("monash-clayton-groups.json").then(r => r.json());
      const aggregateData = await d3.csv("bike-data-per-group.csv");

      const map = L.map("map-internal").setView([-37.909, 145.136], 15);

      const groupLayer = L.geoJson(groupData, {
        onEachFeature: function (feature, layer) {
          const form = document.getElementById("filter").elements;
          layer.addEventListener("click", function () {
            const isLit = form.namedItem("filter-is-lit").checked;
            const parkingType = form.namedItem("filter-parking-type").value;
            const parkingAccess = form.namedItem("filter-parking-access").value;

            let totalCapacity = 0;
            let totalLocations = 0;
            let grandTotalCapacity = 0;
            let grandTotalLocations = 0;

            aggregateData.forEach(function (row) {
              if (isLit && row.lit !== "yes") return;
              if (parkingType !== "all" && row.bicycle_parking !== parkingType) return;
              if (parkingAccess !== "all" && row.access !== parkingAccess) return;

              grandTotalCapacity += Number(row.total_capacity);
              grandTotalLocations += Number(row.total_locations);

              if (row.group !== feature.properties.group) return;
              totalCapacity += Number(row.total_capacity);
              totalLocations += Number(row.total_locations);
            });

            layer.bindPopup(
              `<h4>${feature.properties.name}</h4>
              <p>Total parking spots: ${totalLocations} (out of ${grandTotalLocations})</p>
              <p>Total capacity: ${totalCapacity} bikes (out of ${grandTotalCapacity})</p>`
            ).openPopup();
          });
        },
        style: f => styleGroup(f, aggregateData)
      }).addTo(map);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      document.getElementById("filter").addEventListener("change", () => {
        groupLayer.resetStyle();
      });
    })();

    // Embed Vega-Lite chart from external JSON
    (async function () {
      await vegaEmbed("#lights-chart", "bar_chart.json", { actions: false });
    })();
  </script>
</body>
</html>